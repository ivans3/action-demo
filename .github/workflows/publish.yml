name: Publish Docker image

#on:
#  release:
#    types: [published]

on: push
jobs:
  push_to_registry:
    name: Push Docker image to GitHub Packages
    runs-on: ubuntu-latest
    steps:
      - name: Declare some variables
        id: vars
        shell: bash
        run: |
          echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: setup-buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: registry.stg-platform.hc.ai
          username: ian2
          password: ${{ secrets.HARBOR_USER_PASSWORD }}
      - name: Push to GitHub Packages
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: |
            registry.stg-platform.hc.ai/ian2/fromgithub:${{ steps.vars.outputs.sha_short }}
            registry.stg-platform.hc.ai/ian2/fromgithub:latest
      - uses: goodsmileduck/helm-push-action@v2
        env:
          CHART_FOLDER: 'some-helm-chart'
          FORCE: 'True'
          CHARTMUSEUM_URL: 'https://registry.stg-platform.hc.ai/chartrepo/ian2'
          CHARTMUSEUM_USER: ian2
          CHARTMUSEUM_PASSWORD: ${{ secrets.HARBOR_USER_PASSWORD }}
